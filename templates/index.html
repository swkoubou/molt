<!DOCTYPE html>
<html>
<head>
    <title>Molt | {{ vhost.repo }}</title>
    <style>
    #console {
      height: 500px;
      margin: 10px; padding:10px;
      overflow: scroll;
      color: lightgray;
      background-color: black;
      font-family: monospace;
    }
    .console-row {
      margin: 0px; padding: 0px;
    }
    </style>
</head>
<body>
    <h1>{{ vhost.repo }} molting now...</h1>
    <table>
        <tr><td>User</td><td id=user>{{ vhost.user }}</td></tr>
        <tr><td>Repository</td><td id=repo>{{ vhost.repo }}</td></tr>
        <tr><td>Revision</td><td id=rev>{{ vhost.rev }}</td></tr>
    </table>
    <div id=console></div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
    <script>
    const socket = io.connect('http://' + document.domain + ':' + location.port);
    socket.on('connect', function() {
      console.log('connected')
      socket.emit('molt', {rev:"{{ vhost.rev }}", repo:"{{ vhost.repo }}", user:"{{ vhost.user }}"});
    });
    socket.on('stdio') = function(e) {
      const newElement = document.createElement("p");
      newElement.className = 'console-row';
      newElement.innerHTML = e.data;
      document.getElementById('console').appendChild(newElement);
    }
    socket.on('disconnect') = function(e) {
      location.href = `{{ redirect_url }}`
    }
    </script>
</body>
</html>
